<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI Adventure - Crear Aventura</title>
    <link rel="stylesheet" type="text/css" href="/styles_index.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1 class="main-title">üöó Spring AI Adventure</h1>
        <p class="subtitle">Aventuras √âpicas con el Megalodon de Shark Cars</p>
    </div>

    <div class="welcome-section">
        <p class="welcome-text">
            ¬°Bienvenido a Spring AI Adventure! Prep√°rate para vivir una experiencia √∫nica donde t√∫ eres el protagonista
            de una aventura generada por inteligencia artificial. Cada decisi√≥n que tomes cambiar√° el rumbo de tu
            historia.
        </p>

        <div class="car-info">
            <h4>ü¶à Protagonista Especial: El Megalodon</h4>
            <p>Tu aventura incluir√° el incre√≠ble autom√≥vil "Megalodon" de Shark Cars, un veh√≠culo extraordinario que se
                adaptar√° perfectamente a tu historia.</p>
        </div>

        <ul class="features-list">
            <li>Historias √∫nicas generadas por IA basadas en tus preferencias</li>
            <li>M√∫ltiples g√©neros y ubicaciones para explorar</li>
            <li>Decisiones que impactan el desarrollo de la aventura</li>
            <li>Seguimiento del estado f√≠sico y emocional de tu protagonista</li>
            <li>Diferentes niveles de complejidad y duraci√≥n</li>
        </ul>
    </div>

    <div class="form-section">
        <h2 class="form-title">Crear Tu Aventura</h2>

        <form method="post" action="/adventure/create">
            <div class="form-group">
                <label for="genre">G√©nero de la Aventura <span class="required">*</span></label>
                <select id="genre" name="genre" required>
                    <option value="">Selecciona un g√©nero...</option>
                    <option value="Acci√≥n">Acci√≥n</option>
                    <option value="Aventura">Aventura</option>
                    <option value="Misterio">Misterio</option>
                    <option value="Ciencia Ficci√≥n">Ciencia Ficci√≥n</option>
                    <option value="Fantas√≠a">Fantas√≠a</option>
                    <option value="Thriller">Thriller</option>
                    <option value="Supervivencia">Supervivencia</option>
                    <option value="Espionaje">Espionaje</option>
                </select>
                <div class="form-description">Elige el tipo de aventura que m√°s te emocione</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="protagonistName">Nombre del Protagonista <span class="required">*</span></label>
                    <input type="text" id="protagonistName" name="protagonistName" required
                           placeholder="Ej: Alex Rodr√≠guez">
                    <div class="audio-input-section" style="margin-top: 10px;">
                        <div class="audio-controls">
                            <button type="button" id="recordBtn" class="audio-btn record-btn">üé§ Grabar Nombre</button>
                            <button type="button" id="stopBtn" class="audio-btn stop-btn" disabled>‚èπÔ∏è Detener</button>
                            <button type="button" id="playBtn" class="audio-btn play-btn" disabled>‚ñ∂Ô∏è Reproducir
                            </button>
                            <span id="recordingStatus" class="recording-status"></span>
                        </div>
                        <audio id="audioPlayback" controls style="width: 100%; margin-top: 8px; display: none;"></audio>
                        <input type="hidden" id="audioData" name="audioData">
                    </div>
                    <div class="image-input-section" style="margin-top: 10px;">
                        <div class="image-controls">
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            <button type="button" id="uploadBtn" class="audio-btn upload-btn">üì∑ Subir Imagen</button>
                            <span id="imageStatus" class="image-status"></span>
                        </div>
                        <div id="imagePreview" style="margin-top: 10px; display: none;">
                            <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                        </div>
                        <input type="hidden" id="imageData" name="imageData">
                    </div>
                    <div class="form-description">Escribe tu nombre, gr√°balo usando el micr√≥fono o sube una imagen para generar un nombre</div>
                </div>

                <div class="form-group">
                    <label for="protagonistCount">N√∫mero de Protagonistas <span class="required">*</span></label>
                    <select id="protagonistCount" name="protagonistCount" required>
                        <option value="">Selecciona...</option>
                        <option value="1">1 - Solo</option>
                        <option value="2">2 - D√∫o</option>
                        <option value="3">3 - Tr√≠o</option>
                        <option value="4">4 - Grupo peque√±o</option>
                        <option value="5">5 - Grupo grande</option>
                    </select>
                    <div class="form-description">¬øCu√°ntos protagonistas participar√°n?</div>
                </div>
            </div>

            <div class="form-group">
                <label for="protagonistDescription">Descripci√≥n del Protagonista <span class="required">*</span></label>
                <textarea id="protagonistDescription" name="protagonistDescription" required
                          placeholder="Describe a tu protagonista: personalidad, habilidades, trasfondo..."></textarea>
                <div class="form-description">Describe las caracter√≠sticas, personalidad y habilidades de tu
                    protagonista
                </div>
            </div>

            <div class="form-group">
                <label for="location">Ubicaci√≥n de la Aventura <span class="required">*</span></label>
                <input type="text" id="location" name="location" required
                       placeholder="Ej: Ciudad futurista, Selva amaz√≥nica, Estaci√≥n espacial...">
                <div class="form-description">¬øD√≥nde se desarrollar√° tu aventura?</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="duration">Duraci√≥n de la Aventura <span class="required">*</span></label>
                    <select id="duration" name="duration" required>
                        <option value="">Selecciona duraci√≥n...</option>
                        <option value="SHORT">Corta (5 decisiones)</option>
                        <option value="MEDIUM">Media (10 decisiones)</option>
                        <option value="LONG">Larga (20 decisiones)</option>
                    </select>
                    <div class="form-description">¬øQu√© tan larga quieres que sea tu aventura?</div>
                </div>

                <div class="form-group">
                    <label for="complexity">Complejidad <span class="required">*</span></label>
                    <select id="complexity" name="complexity" required>
                        <option value="">Selecciona complejidad...</option>
                        <option value="LOW">Baja (2 opciones por decisi√≥n)</option>
                        <option value="MEDIUM">Media (3 opciones por decisi√≥n)</option>
                        <option value="HIGH">Alta (5 opciones por decisi√≥n)</option>
                    </select>
                    <div class="form-description">¬øCu√°ntas opciones quieres en cada decisi√≥n?</div>
                </div>
            </div>

            <div class="submit-section">
                <button type="submit" class="btn-submit">üöÄ Comenzar Aventura</button>
            </div>
        </form>
    </div>
</div>

<script>
    class ImageUploader {
        constructor() {
            this.uploadBtn = document.getElementById('uploadBtn');
            this.imageUpload = document.getElementById('imageUpload');
            this.imagePreview = document.getElementById('imagePreview');
            this.previewImg = document.getElementById('previewImg');
            this.imageStatus = document.getElementById('imageStatus');
            this.imageDataInput = document.getElementById('imageData');

            this.initEventListeners();
        }

        initEventListeners() {
            this.uploadBtn.addEventListener('click', () => this.triggerFileSelect());
            this.imageUpload.addEventListener('change', (event) => this.handleImageSelect(event));
        }

        triggerFileSelect() {
            this.imageUpload.click();
        }

        async handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen v√°lido.');
                return;
            }
            this.showImagePreview(file);

            const reader = new FileReader();
            reader.onloadend = async () => {
                this.imageDataInput.value = reader.result;
            };
            reader.readAsDataURL(file);
            await this.analyzeImage(file);
        }

        showImagePreview(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.previewImg.src = e.target.result;
                this.imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async analyzeImage(file) {
            try {
                this.imageStatus.textContent = 'Analizando imagen con IA...';
                this.uploadBtn.disabled = true;

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/image-analyzer', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const generatedName = await response.text();
                    document.getElementById('protagonistName').value = generatedName.trim();
                    this.imageStatus.textContent = 'Nombre generado: "' + generatedName.trim() + '"';
                } else {
                    this.imageStatus.textContent = 'Error al analizar la imagen';
                }
            } catch (error) {
                console.error('Error analyzing image:', error);
                this.imageStatus.textContent = 'Error al conectar con el servicio de an√°lisis';
            } finally {
                this.uploadBtn.disabled = false;
            }
        }
    }

    class AudioRecorder {
        constructor() {
            this.mediaRecorder = null;
            this.audioChunks = [];
            this.recordBtn = document.getElementById('recordBtn');
            this.stopBtn = document.getElementById('stopBtn');
            this.playBtn = document.getElementById('playBtn');
            this.audioPlayback = document.getElementById('audioPlayback');
            this.recordingStatus = document.getElementById('recordingStatus');
            this.audioDataInput = document.getElementById('audioData');

            this.initEventListeners();
        }

        initEventListeners() {
            this.recordBtn.addEventListener('click', () => this.startRecording());
            this.stopBtn.addEventListener('click', () => this.stopRecording());
            this.playBtn.addEventListener('click', () => this.playAudio());
        }

        async startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                this.mediaRecorder = new MediaRecorder(stream);
                this.audioChunks = [];

                this.mediaRecorder.ondataavailable = (event) => {
                    this.audioChunks.push(event.data);
                };

                this.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(this.audioChunks, {type: 'audio/wav'});
                    this.audioPlayback.src = URL.createObjectURL(audioBlob);
                    this.audioPlayback.style.display = 'block';
                    this.playBtn.disabled = false;

                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        this.audioDataInput.value = reader.result;

                        this.recordingStatus.textContent = 'Convirtiendo audio a texto...';
                        const response = await fetch('/speech-text', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(reader.result)
                        });

                        if (response.ok) {
                            const transcribedText = await response.text();
                            document.getElementById('protagonistName').value = transcribedText.trim();
                            this.recordingStatus.textContent = 'Texto convertido: "' + transcribedText.trim() + '"';
                        } else {
                            this.recordingStatus.textContent = 'Error al convertir audio a texto/test';
                        }
                    };
                    reader.readAsDataURL(audioBlob);

                    stream.getTracks().forEach(track => track.stop());
                };

                this.mediaRecorder.start();
                this.updateUIForRecording(true);
                this.recordingStatus.textContent = 'Grabando...';

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('No se pudo acceder al micr√≥fono. Aseg√∫rate de dar permisos.');
            }
        }

        stopRecording() {
            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                this.mediaRecorder.stop();
                this.updateUIForRecording(false);
                this.recordingStatus.textContent = 'Grabaci√≥n completada';
            }
        }

        playAudio() {
            if (this.audioPlayback.src) {
                this.audioPlayback.play();
            }
        }

        updateUIForRecording(isRecording) {
            this.recordBtn.disabled = isRecording;
            this.stopBtn.disabled = !isRecording;

            if (isRecording) {
                this.recordBtn.classList.add('recording');
                this.recordBtn.textContent = 'üî¥ Grabando...';
            } else {
                this.recordBtn.classList.remove('recording');
                this.recordBtn.textContent = 'üé§ Grabar Nombre';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new AudioRecorder();
        new ImageUploader();
    });
</script>
</body>
</html>